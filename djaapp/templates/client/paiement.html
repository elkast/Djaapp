{% extends "base.html" %}

{% block titre %}Paiement - Djaapp{% endblock %}

{% block contenu %}
<div class="row g-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/client/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/client/panier">Panier</a></li>
        <li class="breadcrumb-item active" aria-current="page">Paiement</li>
      </ol>
    </nav>
  </div>

  <div class="col-12">
    <div class="text-center mb-4">
      <h1 class="h4 fw-semibold">Finaliser votre commande</h1>
      <p class="text-muted">Sélectionnez votre méthode de paiement</p>
    </div>
  </div>

  <!-- Progress bar -->
  <div class="col-12">
    <div class="progress mb-4" style="height: 8px;">
      <div class="progress-bar bg-primaire" role="progressbar" style="width: {{ etape * 33.33 }}%;" aria-valuenow="{{ etape * 33 }}" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="d-flex justify-content-between text-center">
      <div class="flex-fill">
        <div class="fw-semibold {{ 'text-primaire' if etape >= 1 else 'text-muted' }}">1. Panier</div>
        <small class="text-muted">Vérification</small>
      </div>
      <div class="flex-fill">
        <div class="fw-semibold {{ 'text-primaire' if etape >= 2 else 'text-muted' }}">2. Paiement</div>
        <small class="text-muted">Sélection</small>
      </div>
      <div class="flex-fill">
        <div class="fw-semibold {{ 'text-primaire' if etape >= 3 else 'text-muted' }}">3. Confirmation</div>
        <small class="text-muted">Finalisation</small>
      </div>
    </div>
  </div>

  {% if etape == 1 %}
  <!-- Étape 1: Résumé de la commande -->
  <div class="col-12 col-lg-8">
    <div class="card ombre-douce border-0">
      <div class="card-body p-4">
        <h5 class="card-title fw-semibold mb-4">
          <i class="fas fa-shopping-cart me-2 text-primaire"></i>Résumé de votre commande
        </h5>

        <div class="row g-3">
          {% for item in items %}
          <div class="col-12">
            <div class="card border-0 bg-light">
              <div class="card-body p-3">
                <div class="row align-items-center">
                  <div class="col-md-7">
                    <h6 class="card-title fw-semibold mb-1">{{ item.nom }}</h6>
                    <p class="card-text small text-muted mb-0">{{ item.nom_boutique }}</p>
                  </div>
                  <div class="col-md-2 text-center">
                    <span class="badge bg-secondary">x{{ item.quantite }}</span>
                  </div>
                  <div class="col-md-3 text-md-end">
                    <span class="fw-semibold text-primaire">{{ item.prix_unitaire * item.quantite }} FCFA</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
          <a href="/client/panier" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-arrow-left me-2"></i>Retour au panier
          </a>
          <form method="post" action="/client/paiement/continuer" class="d-inline">
            <input type="hidden" name="etape_suivante" value="2">
            <button class="btn btn-primaire btn-lg fw-semibold" type="submit">
              Continuer vers le paiement <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  {% elif etape == 2 %}
  <!-- Étape 2: Méthodes de paiement -->
  <div class="col-12 col-lg-8">
    <div class="card ombre-douce border-0">
      <div class="card-body p-4">
        <h5 class="card-title fw-semibold mb-4">
          <i class="fas fa-credit-card me-2 text-primaire"></i>Choisissez votre méthode de paiement
        </h5>

        <div class="row g-4">
          <!-- Mobile Money -->
          <div class="col-12 col-md-6">
            <div class="card border-2 border-primaire h-100" style="cursor: pointer;" onclick="selectPaymentMethod('mobile-money')">
              <div class="card-body text-center p-4">
                <i class="fas fa-mobile-alt fa-3x text-primaire mb-3"></i>
                <h6 class="card-title fw-semibold">Mobile Money</h6>
                <p class="card-text small text-muted">Orange Money, Moov Money, MTN Mobile Money</p>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="methode_paiement" value="mobile_money" id="mobile-money-radio">
                  <label class="form-check-label fw-semibold" for="mobile-money-radio">
                    Sélectionner
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Carte bancaire -->
          <div class="col-12 col-md-6">
            <div class="card border-2 border-secondaire h-100" style="cursor: pointer;" onclick="selectPaymentMethod('carte')">
              <div class="card-body text-center p-4">
                <i class="fas fa-credit-card fa-3x text-secondaire mb-3"></i>
                <h6 class="card-title fw-semibold">Carte bancaire</h6>
                <p class="card-text small text-muted">Visa, Mastercard, sécurisé par Stripe</p>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="methode_paiement" value="carte" id="carte-radio">
                  <label class="form-check-label fw-semibold" for="carte-radio">
                    Sélectionner
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Formulaire Mobile Money -->
        <div id="mobile-money-form" class="mt-4" style="display: none;">
          <div class="card border-0 bg-light">
            <div class="card-body p-4">
              <h6 class="fw-semibold mb-3">Informations Mobile Money</h6>
              <form method="post" action="/client/paiement/mobile-money">
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label fw-semibold" for="champ-operateur">Opérateur *</label>
                    <select id="champ-operateur" name="operateur" class="form-select form-select-lg" required>
                      <option value="">Choisir un opérateur</option>
                      <option value="orange">Orange Money</option>
                      <option value="moov">Moov Money</option>
                      <option value="mtn">MTN Mobile Money</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label fw-semibold" for="champ-tel">Numéro de téléphone *</label>
                    <input id="champ-tel" name="telephone" class="form-control form-control-lg" required placeholder="07 00 00 00 00">
                  </div>
                  <div class="col-12">
                    <button class="btn btn-primaire btn-lg w-100 fw-semibold" type="submit">
                      <i class="fas fa-mobile-alt me-2"></i>Procéder au paiement
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Formulaire Carte -->
        <div id="carte-form" class="mt-4" style="display: none;">
          <div class="card border-0 bg-light">
            <div class="card-body p-4">
              <h6 class="fw-semibold mb-3">Informations de carte</h6>
              <form method="post" action="/client/paiement/carte">
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label fw-semibold" for="champ-nom-carte">Nom sur la carte *</label>
                    <input id="champ-nom-carte" name="nom_carte" class="form-control form-control-lg" required placeholder="JOHN DOE">
                  </div>
                  <div class="col-12">
                    <label class="form-label fw-semibold" for="champ-num-carte">Numéro de carte *</label>
                    <input id="champ-num-carte" name="numero_carte" class="form-control form-control-lg" required placeholder="1234 5678 9012 3456">
                  </div>
                  <div class="col-6">
                    <label class="form-label fw-semibold" for="champ-exp">Date d'expiration *</label>
                    <input id="champ-exp" name="expiration" class="form-control form-control-lg" required placeholder="MM/AA">
                  </div>
                  <div class="col-6">
                    <label class="form-label fw-semibold" for="champ-cvc">CVC *</label>
                    <input id="champ-cvc" name="cvc" class="form-control form-control-lg" required placeholder="123">
                  </div>
                  <div class="col-12">
                    <button class="btn btn-secondaire btn-lg w-100 fw-semibold" type="submit">
                      <i class="fas fa-credit-card me-2"></i>Payer maintenant
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
          <button class="btn btn-outline-secondary btn-lg" onclick="retourEtape1()">
            <i class="fas fa-arrow-left me-2"></i>Retour
          </button>
        </div>
      </div>
    </div>
  </div>

  {% elif etape == 3 %}
  <!-- Étape 3: Confirmation -->
  <div class="col-12 col-lg-8">
    <div class="card ombre-douce border-0">
      <div class="card-body text-center p-5">
        <i class="fas fa-check-circle fa-4x text-success mb-4"></i>
        <h5 class="card-title fw-semibold text-success mb-3">Paiement réussi !</h5>
        <p class="card-text text-muted mb-4">
          Votre commande a été confirmée et sera traitée dans les plus brefs délais.
          Vous recevrez un SMS de confirmation.
        </p>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
          <a href="/client/commandes" class="btn btn-primaire btn-lg fw-semibold">
            <i class="fas fa-list me-2"></i>Voir mes commandes
          </a>
          <a href="/client/dashboard" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-store me-2"></i>Continuer mes achats
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Récapitulatif -->
  <div class="col-12 col-lg-4">
    <div class="card ombre-douce border-0 sticky-top" style="top: 20px;">
      <div class="card-body p-4">
        <h6 class="card-title fw-semibold mb-3">
          <i class="fas fa-receipt me-2 text-primaire"></i>Récapitulatif
        </h6>

        <div class="mb-3">
        <div class="d-flex justify-content-between mb-2">
          <span>Sous-total</span>
          <span>{{ panier.total or 0 }} FCFA</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Frais de livraison</span>
          <span class="text-success">Gratuit</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between mb-0">
          <strong class="fs-5">Total</strong>
          <strong class="fs-5 text-primaire">{{ panier.total or 0 }} FCFA</strong>
        </div>
        </div>

        {% if etape == 1 %}
        <div class="alert alert-info">
          <small><i class="fas fa-info-circle me-1"></i>Livraison gratuite pour toute commande !</small>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
function selectPaymentMethod(method) {
  // Reset selections
  document.querySelectorAll('.card').forEach(card => {
    card.classList.remove('border-primaire', 'border-secondaire');
    card.classList.add('border-2');
  });

  // Select the chosen method
  if (method === 'mobile-money') {
    document.getElementById('mobile-money-radio').checked = true;
    document.getElementById('carte-radio').checked = false;
    document.querySelector('.card:nth-child(1)').classList.add('border-primaire');
    document.getElementById('mobile-money-form').style.display = 'block';
    document.getElementById('carte-form').style.display = 'none';
  } else if (method === 'carte') {
    document.getElementById('carte-radio').checked = true;
    document.getElementById('mobile-money-radio').checked = false;
    document.querySelector('.card:nth-child(2)').classList.add('border-secondaire');
    document.getElementById('carte-form').style.display = 'block';
    document.getElementById('mobile-money-form').style.display = 'none';
  }
}

function retourEtape1() {
  window.location.href = '/client/paiement?etape=1';
}
</script>
{% endblock %}
